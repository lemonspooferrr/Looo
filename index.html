<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>LemonSpoofer - Appel Spoof WebRTC</title>
</head>
<body>
    <h2>🎧 LemonSpoofer - Interface Complète</h2>

    <h3>🎙️ Test Micro (Loopback)</h3>
    <button onclick="testMic()">Tester le micro</button>
    <p id="mic-status">🎤 En attente...</p>
    <audio id="playback" controls></audio>

    <hr>

    <h3>📞 Appel Spoof (SIP.js)</h3>
    <p>📲 <b>Caller ID :</b> +33969353969<br>
    🎯 <b>Vers :</b> +33756836479</p>
    <button id="callBtn">📲 Appeler maintenant</button>
    <p id="call-status">En attente...</p>

    <!-- ✅ Bonne version SIP.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sip.js/0.11.6/sip.min.js"></script>

    <script>
        // Test micro loopback
        function testMic() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    document.getElementById("mic-status").innerText = "✅ Micro actif détecté.";
                    const playback = document.getElementById("playback");
                    playback.srcObject = stream;
                    playback.play();
                })
                .catch(err => {
                    document.getElementById("mic-status").innerText = "❌ Erreur : " + err.message;
                });
        }

        // SIP.js classique
        const userAgent = new SIP.UA({
            uri: 'testspoof123@sip.portsip.com',
            wsServers: ['wss://sip.portsip.com:5063'],
            authorizationUser: 'testspoof123',
            password: 'x6f89sPoof',
            displayName: '+33969353969'
        });

        userAgent.on('connected', () => {
            console.log("✅ Connecté au serveur SIP");
            document.getElementById("call-status").innerText = "✅ Connecté au serveur SIP";
        });

        userAgent.on('registered', () => {
            console.log("📡 Enregistré SIP");
            document.getElementById("call-status").innerText = "📡 Enregistré sur PortSIP";
        });

        document.getElementById("callBtn").onclick = () => {
            console.log("🟢 Bouton appel cliqué");
            document.getElementById("call-status").innerText = "📞 Connexion en cours...";

            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    const session = userAgent.invite('sip:+33756836479@sip.portsip.com', {
                        media: {
                            stream: stream
                        }
                    });

                    session.on('accepted', () => {
                        document.getElementById("call-status").innerText = "✅ Appel accepté !";
                    });

                    session.on('bye', () => {
                        document.getElementById("call-status").innerText = "📴 Appel terminé.";
                    });

                    session.on('failed', () => {
                        document.getElementById("call-status").innerText = "❌ Échec de l’appel.";
                    });
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById("call-status").innerText = "❌ Erreur micro : " + err.message;
                });
        };
    </script>
</body>
</html>
