<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>LemonSpoofer - WebRTC Appel</title>
</head>
<body>
  <h2>🍋 LemonSpoofer - Interface Complète</h2>

  <h3>🎙️ Test Micro (Loopback)</h3>
  <button onclick="testerMicro()">Tester le micro</button>
  <p id="microStatus">🔴 Micro inactif.</p>
  <audio id="player" controls></audio>

  <hr />
  <h3>📞 Appel Spoof (SIP.js)</h3>
  <p><b>📇 Caller ID :</b> +33969353969<br />
     <b>🌐 Vers :</b> +33756836479</p>
  <button onclick="appeler()">📞 Appeler maintenant</button>
  <p id="appelStatus">En attente...</p>

  <script src="https://unpkg.com/sip.js@0.20.0/dist/sip.min.js"></script>
  <script>
    // 1. Test Micro
    function testerMicro() {
      navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
        document.getElementById('microStatus').textContent = "🟢 Micro actif détecté.";
        document.getElementById('player').srcObject = stream;
      }).catch((err) => {
        document.getElementById('microStatus').textContent = "🔴 Erreur micro : " + err;
      });
    }

    // 2. Init SIP
    let userAgent;

    window.onload = () => {
      userAgent = new SIP.UserAgent({
        uri: 'demo2@portsip.click',
        transportOptions: {
          server: 'wss://sip.portsip.click:8089'
        },
        authorizationUsername: 'demo2',
        authorizationPassword: 'demo2',
        displayName: 'LemonSpoofer'
      });
      userAgent.start()
        .then(() => console.log("✅ UA initialisé"))
        .catch(err => console.error("UA Start error", err));
    };

    function appeler() {
      if (!userAgent || !userAgent.isStarted()) {
        document.getElementById('appelStatus').textContent = "❌ UA non initialisé.";
        return;
      }

      const target = 'sip:+33756836479@sip.portsip.click';
      const inviter = new SIP.Inviter(userAgent, target);
      inviter.invite().then(() => {
        document.getElementById('appelStatus').textContent = "📞 Appel lancé...";
      }).catch((error) => {
        document.getElementById('appelStatus').textContent = "❌ Échec de l’appel : " + error;
      });
    }
  </script>
</body>
</html>
